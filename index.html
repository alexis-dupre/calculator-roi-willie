<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur ROI Willie - Économies d'eau garanties</title>
    
    <style>
        /* Variables CSS - Charte graphique Willie */
        :root {
            /* Couleurs principales Willie */
            --willie-black: #121212;
            --willie-dark-bg: #1a1a1a;
            --willie-card-bg: #212121;
            --willie-blue-primary: #ededed;
            --willie-blue-hover: #b5b5b5;
            --willie-green: #ededed;
            --willie-red: #b5b5b5;
            --willie-yellow: #b5b5b5;
            --willie-white: #ededed;
            --willie-gray-100: #ededed;
            --willie-gray-200: #b5b5b5;
            --willie-gray-300: #7a7a7a;
            --willie-gray-400: #6e6e6e;
            --willie-gray-500: #616161;
            --willie-gray-600: #474747;
            --willie-border: rgba(255, 255, 255, 0.07);
            --willie-border-hover: rgba(255, 255, 255, 0.17);
            
            /* Gradients */
            --willie-gradient: linear-gradient(135deg, rgba(255, 255, 255, 0.23) 0%, rgba(255, 255, 255, 0.13) 100%);
            --willie-gradient-green: linear-gradient(135deg, rgba(255, 255, 255, 0.33) 0%, rgba(255, 255, 255, 0.23) 100%);
            
            /* Ombres */
            --willie-shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --willie-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --willie-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
            --willie-shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.3);
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Responsive font sizes */
            --fs-xs: clamp(0.75rem, 2vw, 0.875rem);
            --fs-sm: clamp(0.875rem, 2.5vw, 1rem);
            --fs-base: clamp(1rem, 3vw, 1.125rem);
            --fs-lg: clamp(1.125rem, 3.5vw, 1.25rem);
            --fs-xl: clamp(1.25rem, 4vw, 1.5rem);
            --fs-2xl: clamp(1.5rem, 5vw, 2rem);
            --fs-3xl: clamp(2rem, 6vw, 3rem);
            --fs-4xl: clamp(2.5rem, 7vw, 4rem);
            
            /* Responsive spacing */
            --spacing-xs: clamp(0.25rem, 1vw, 0.5rem);
            --spacing-sm: clamp(0.5rem, 2vw, 0.75rem);
            --spacing-md: clamp(0.75rem, 3vw, 1rem);
            --spacing-lg: clamp(1rem, 4vw, 1.5rem);
            --spacing-xl: clamp(1.5rem, 5vw, 2rem);
            --spacing-2xl: clamp(2rem, 6vw, 3rem);
            --spacing-3xl: clamp(3rem, 8vw, 4rem);
        }

        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
            background: var(--willie-black);
            color: var(--willie-white);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-md);
            font-size: var(--fs-base);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        /* Container principal */
        .calculator-container {
            width: 100%;
            max-width: min(900px, 95vw);
            background: var(--willie-dark-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--willie-border);
            padding: var(--spacing-2xl);
            box-shadow: var(--willie-shadow-xl);
            position: relative;
            z-index: 2;
            overflow: hidden;
        }

        /* Glow effect */
        .calculator-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--willie-gradient);
            border-radius: 24px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .calculator-container:hover::before {
            opacity: 0.1;
        }

        /* Intégration transparente dans iframe */
        .in-iframe .calculator-container {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            backdrop-filter: none;
            max-width: 100%;
        }

        .in-iframe .calculator-container::before {
            display: none;
        }

        .in-iframe body {
            background: transparent;
            padding: 0;
            min-height: auto;
        }

        .in-iframe body::before {
            display: none;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: var(--spacing-3xl);
        }

        .calculator-header h1 {
            font-size: var(--fs-3xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            background: linear-gradient(135deg, var(--willie-white) 0%, var(--willie-blue-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .calculator-header p {
            color: var(--willie-gray-400);
            font-size: var(--fs-lg);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Type selector */
        .calculator-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .type-option {
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 16px;
            padding: var(--spacing-xl);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .type-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--willie-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .type-option:hover {
            border-color: var(--willie-blue-primary);
            transform: translateY(-2px);
            box-shadow: var(--willie-shadow-lg);
        }

        .type-option:hover::before {
            opacity: 0.05;
        }

        .type-option.selected {
            background: var(--willie-card-bg);
            border-color: var(--willie-blue-primary);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.11);
        }

        .type-option.selected::before {
            opacity: 0.1;
        }

        .type-option h3 {
            color: var(--willie-white);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--fs-xl);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .type-option .icon {
            font-size: 1.5em;
            background: var(--willie-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }

        .type-option p {
            color: var(--willie-gray-300);
            font-size: var(--fs-base);
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }

        .type-option small {
            color: var(--willie-gray-500);
            font-size: var(--fs-sm);
            position: relative;
            z-index: 1;
        }

        /* Form styles */
        .calculator-form {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .calculator-form.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-step h2 {
            font-size: var(--fs-2xl);
            font-weight: 600;
            margin-bottom: var(--spacing-xl);
            color: var(--willie-white);
        }

        /* Form controls */
        .form-group {
            margin-bottom: var(--spacing-xl);
            position: relative;
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--willie-gray-300);
            font-weight: 500;
            font-size: var(--fs-sm);
            letter-spacing: 0.01em;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 12px;
            color: var(--willie-white);
            font-size: var(--fs-base);
            transition: var(--transition);
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit;
        }

        input::placeholder {
            color: var(--willie-gray-500);
        }

        input:hover,
        select:hover {
            border-color: var(--willie-border-hover);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--willie-blue-primary);
            background: rgba(255, 255, 255, 0.04);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.07);
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-lg);
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .radio-option:hover {
            border-color: var(--willie-border-hover);
            background: rgba(255, 255, 255, 0.04);
        }

        .radio-option input[type="radio"] {
            margin-right: var(--spacing-md);
            margin-top: 2px;
            width: 20px;
            height: 20px;
            accent-color: var(--willie-blue-primary);
            flex-shrink: 0;
        }

        .radio-option label {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: 0;
            font-size: var(--fs-base);
            color: var(--willie-white);
        }

        .radio-option input[type="number"] {
            width: 150px;
            min-width: 120px;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-top: var(--spacing-xs);
            background: var(--willie-black);
            border: 1px solid var(--willie-border);
        }

        /* Buttons */
        .button {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--willie-gradient);
            border: none;
            border-radius: 12px;
            color: var(--willie-white);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: var(--willie-shadow-md);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.02em;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transition: width 0.6s, height 0.6s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: var(--willie-shadow-lg);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.17) 0%, rgba(255, 255, 255, 0.23) 100%);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:active::before {
            width: 300px;
            height: 300px;
        }

        .button.secondary {
            background: transparent;
            border: 2px solid var(--willie-border);
            color: var(--willie-white);
            box-shadow: none;
        }

        .button.secondary:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--willie-gray-400);
            transform: translateY(-1px);
        }

        /* Navigation */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-2xl);
            flex-wrap: wrap;
        }

        /* Progress bar */
        .progress-bar {
            height: 4px;
            background: var(--willie-border);
            border-radius: 2px;
            margin-bottom: var(--spacing-2xl);
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--willie-gradient);
            border-radius: 2px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Site navigation */
        .site-navigation {
            margin: var(--spacing-xl) 0;
            display: flex;
            justify-content: center;
        }

        .progress-dots {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--willie-border);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .progress-dot.active {
            background: var(--willie-blue-primary);
            width: 14px;
            height: 14px;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.11);
        }

        .progress-dot.completed {
            background: var(--willie-green);
        }

        .progress-dot:hover:not(.active) {
            background: var(--willie-gray-500);
        }

        /* Results section */
        .calculator-results {
            display: none;
            animation: fadeIn 0.8s ease-out;
        }

        .calculator-results.active {
            display: block;
        }

        .main-savings {
            background: var(--willie-gradient);
            border-radius: 20px;
            padding: var(--spacing-3xl);
            margin-bottom: var(--spacing-2xl);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--willie-shadow-xl);
        }

        .main-savings::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .main-savings h2 {
            font-size: var(--fs-xl);
            margin-bottom: var(--spacing-md);
            position: relative;
            z-index: 1;
            font-weight: 600;
            color: var(--willie-white);
        }

        .savings-amount {
            font-size: var(--fs-4xl);
            font-weight: 700;
            color: var(--willie-white);
            margin: var(--spacing-xl) 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
        }

        .teaser-message {
            position: relative;
            z-index: 1;
            color: var(--willie-white);
        }

        .teaser-message p {
            font-size: var(--fs-lg);
            margin-bottom: var(--spacing-xl);
            font-weight: 500;
        }

        .teaser-message ul {
            text-align: left;
            display: inline-block;
            max-width: 500px;
            font-size: var(--fs-base);
        }

        .teaser-message li {
            margin-bottom: var(--spacing-md);
            list-style: none;
            position: relative;
            padding-left: var(--spacing-xl);
        }

        .teaser-message li::before {
            content: '✓';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--willie-white);
            font-weight: bold;
            font-size: 1.2em;
        }

        /* Benefit cards */
        .additional-benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .benefit-card {
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 16px;
            padding: var(--spacing-xl);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .benefit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--willie-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .benefit-card:hover {
            transform: translateY(-4px);
            border-color: var(--willie-blue-primary);
            box-shadow: var(--willie-shadow-lg);
        }

        .benefit-card:hover::before {
            opacity: 0.03;
        }

        .benefit-card .icon {
            font-size: 2.5em;
            margin-bottom: var(--spacing-md);
            display: block;
            position: relative;
            z-index: 1;
        }

        .benefit-card h4 {
            color: var(--willie-white);
            margin-bottom: var(--spacing-sm);
            font-size: var(--fs-lg);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .benefit-card p {
            color: var(--willie-gray-300);
            font-size: var(--fs-sm);
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        /* Email capture */
        .calculator-cta {
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 20px;
            padding: var(--spacing-3xl);
            text-align: center;
            margin-top: var(--spacing-2xl);
            position: relative;
            overflow: hidden;
        }

        .calculator-cta::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--willie-gradient);
            border-radius: 20px;
            opacity: 0.1;
            z-index: 0;
        }

        .calculator-cta h3 {
            color: var(--willie-white);
            margin-bottom: var(--spacing-md);
            font-size: var(--fs-2xl);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .calculator-cta p {
            font-size: var(--fs-base);
            margin-bottom: var(--spacing-xl);
            color: var(--willie-gray-300);
            position: relative;
            z-index: 1;
        }

        /* Elegant form */
        .elegant-form {
            max-width: 500px;
            margin: 0 auto;
            margin-top: var(--spacing-xl);
            position: relative;
            z-index: 1;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-field {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .form-field input {
            width: 100%;
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid var(--willie-border);
            border-radius: 12px;
            color: var(--willie-white);
            font-size: var(--fs-base);
            transition: var(--transition);
        }

        .form-field label {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--willie-gray-400);
            font-size: var(--fs-base);
            pointer-events: none;
            transition: var(--transition);
            background: var(--willie-card-bg);
            padding: 0 8px;
        }

        .form-field input:focus + label,
        .form-field input:valid + label {
            top: 0;
            font-size: var(--fs-sm);
            color: var(--willie-blue-primary);
        }

        .consent-group {
            display: flex;
            align-items: flex-start;
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-lg);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.07);
        }

        .consent-group input[type="checkbox"] {
            margin-right: var(--spacing-md);
            margin-top: 2px;
            width: 18px;
            height: 18px;
            accent-color: var(--willie-blue-primary);
            cursor: pointer;
            flex-shrink: 0;
        }

        .consent-group label {
            font-size: var(--fs-sm);
            color: var(--willie-gray-300);
            cursor: pointer;
            line-height: 1.5;
            margin-bottom: 0;
        }

        .submit-button {
            width: 100%;
            padding: var(--spacing-lg);
            font-size: var(--fs-base);
            margin-top: var(--spacing-lg);
            background: var(--willie-gradient-green);
            font-weight: 600;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.07);
        }

        .submit-button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.39) 0%, rgba(255, 255, 255, 0.33) 100%);
            box-shadow: 0 6px 30px rgba(255, 255, 255, 0.11);
        }

        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: var(--spacing-3xl);
        }

        .loading.active {
            display: block;
        }

        .loading p {
            font-size: var(--fs-lg);
            color: var(--willie-gray-300);
            margin-top: var(--spacing-xl);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--willie-border);
            border-top-color: var(--willie-blue-primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success message */
        .success-message {
            display: none;
            text-align: center;
            padding: var(--spacing-3xl);
        }

        .success-message.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .success-message h2 {
            font-size: var(--fs-2xl);
            margin-bottom: var(--spacing-md);
            color: var(--willie-white);
        }

        .success-message p {
            font-size: var(--fs-base);
            margin-bottom: var(--spacing-sm);
            color: var(--willie-gray-300);
        }

        .success-icon {
            font-size: 4em;
            color: var(--willie-green);
            margin-bottom: var(--spacing-xl);
            display: inline-block;
            animation: pulseScale 2s ease-in-out infinite;
        }

        @keyframes pulseScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Address autocomplete */
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--willie-card-bg);
            border: 2px solid var(--willie-border);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 240px;
            overflow-y: auto;
            display: none;
            z-index: 10;
            box-shadow: var(--willie-shadow-lg);
        }

        .address-suggestions.active {
            display: block;
        }

        .address-suggestion {
            padding: var(--spacing-md);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--willie-border);
            font-size: var(--fs-base);
            color: var(--willie-gray-300);
        }

        .address-suggestion:last-child {
            border-bottom: none;
        }

        .address-suggestion:hover {
            background: rgba(255, 255, 255, 0.07);
            color: var(--willie-white);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 8px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: min(280px, 80vw);
            background-color: var(--willie-card-bg);
            color: var(--willie-gray-300);
            text-align: left;
            border-radius: 8px;
            padding: var(--spacing-md);
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: var(--fs-sm);
            line-height: 1.5;
            border: 1px solid var(--willie-border);
            box-shadow: var(--willie-shadow-md);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Metric highlights */
        .metric {
            display: inline-block;
            background: rgba(255, 255, 255, 0.07);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 24px;
            font-weight: 600;
            color: var(--willie-blue-primary);
            margin: 0 4px;
            font-size: var(--fs-sm);
            border: 1px solid rgba(255, 255, 255, 0.11);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--willie-black);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--willie-gray-600);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--willie-gray-500);
        }

        /* Tablet styles */
        @media (max-width: 768px) {
            .calculator-container {
                padding: var(--spacing-xl);
                border-radius: 20px;
            }

            .form-navigation {
                gap: var(--spacing-md);
            }

            .button {
                flex: 1;
                min-width: 140px;
            }

            .type-option {
                padding: var(--spacing-lg);
            }

            .main-savings {
                padding: var(--spacing-2xl);
            }

            .benefit-card {
                padding: var(--spacing-lg);
            }

            .radio-option label {
                flex-direction: column;
                align-items: flex-start;
            }

            .radio-option input[type="number"] {
                width: 100%;
                margin-top: var(--spacing-md);
            }

            .calculator-cta {
                padding: var(--spacing-2xl);
            }
        }

        /* Mobile styles */
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
                align-items: flex-start;
                padding-top: var(--spacing-xl);
            }

            .calculator-container {
                min-height: 100vh;
                border-radius: 16px;
                padding: var(--spacing-lg);
            }

            .calculator-header h1 {
                font-size: var(--fs-2xl);
            }

            .calculator-type-selector {
                grid-template-columns: 1fr;
            }

            .form-navigation {
                flex-direction: column-reverse;
            }

            .button {
                width: 100%;
                min-width: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .additional-benefits {
                grid-template-columns: 1fr;
            }

            .main-savings {
                padding: var(--spacing-xl);
            }

            .calculator-cta {
                padding: var(--spacing-xl);
            }

            .teaser-message ul {
                padding-left: var(--spacing-xl);
            }

            .address-suggestions {
                max-height: 180px;
            }

            .tooltip .tooltiptext {
                bottom: auto;
                top: 125%;
                left: -120px;
                margin-left: 0;
            }
        }

        /* Landscape mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                padding: var(--spacing-sm);
            }

            .calculator-container {
                max-height: 95vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .calculator-header {
                margin-bottom: var(--spacing-xl);
            }

            .main-savings {
                padding: var(--spacing-lg);
            }
        }

        /* High DPI screens */
        @media (min-resolution: 2dppx) {
            .calculator-container,
            .type-option,
            .radio-option,
            .benefit-card {
                border-width: 1px;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .button,
            .type-option,
            .radio-option,
            .progress-dot {
                min-height: 48px;
                min-width: 48px;
            }

            input[type="checkbox"],
            input[type="radio"] {
                min-width: 24px;
                min-height: 24px;
            }
        }

        /* Very small devices */
        @media (max-width: 320px) {
            :root {
                --fs-base: 0.9375rem;
                --fs-3xl: 1.75rem;
                --fs-4xl: 2.25rem;
            }

            .calculator-header h1 {
                word-break: break-word;
                hyphens: auto;
            }

            .savings-amount {
                word-break: break-all;
            }
        }

        /* Print styles */
        @media print {
            .button,
            .progress-bar,
            .form-navigation,
            .calculator-cta {
                display: none;
            }

            body {
                background: white;
                color: black;
            }

            .calculator-container {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <!-- Header -->
        <div class="calculator-header">
            <h1>Calculez vos économies d'eau avec Willie</h1>
            <p>Découvrez en 2 minutes combien vous pouvez économiser grâce à notre solution de télérelève intelligente. Détection de fuites en temps réel, automatisation des relevés et optimisation de votre consommation.</p>
        </div>

        <!-- Progress bar -->
        <div class="progress-bar">
            <div class="progress-fill" style="width: 20%;"></div>
        </div>

        <!-- Type selector -->
        <div class="calculator-type-selector" id="typeSelector">
            <div class="type-option" data-type="simplified">
                <h3><span class="icon">⚡</span> Calcul rapide</h3>
                <p>Estimation globale en 2 minutes</p>
                <small>Idéal pour une première approche</small>
            </div>
            <div class="type-option" data-type="detailed">
                <h3><span class="icon">🎯</span> Calcul détaillé</h3>
                <p>Résultats précis par site en 5 minutes</p>
                <small>Pour une analyse approfondie</small>
            </div>
        </div>

        <!-- Simplified form -->
        <div class="calculator-form" id="simplifiedForm">
            <div class="form-step active">
                <h2>Informations générales</h2>
                
                <div class="form-group">
                    <label for="nbSites">Nombre de sites</label>
                    <input type="number" id="nbSites" min="1" value="1" required>
                </div>

                <div class="form-group">
                    <label for="nbCompteurs">Nombre total de compteurs</label>
                    <input type="number" id="nbCompteurs" min="1" required>
                </div>

                <div class="form-group">
                    <label>Consommation annuelle d'eau</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="consoGlobale" name="consoType" value="global" checked>
                            <label for="consoGlobale">
                                Consommation globale tous sites : 
                                <input type="number" id="consoGlobaleValue" placeholder="m³/an" style="width: 150px; margin-left: 10px;">
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="consoMoyenne" name="consoType" value="average">
                            <label for="consoMoyenne">
                                Consommation moyenne par site : 
                                <input type="number" id="consoMoyenneValue" placeholder="m³/an" style="width: 150px; margin-left: 10px;">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button class="button secondary" onclick="resetCalculator()">Retour</button>
                    <button class="button" onclick="calculateSimplified()">Calculer mes économies</button>
                </div>
            </div>
        </div>

        <!-- Detailed form -->
        <div class="calculator-form" id="detailedForm">
            <div class="form-step active" id="step1">
                <h2>Nombre de sites à analyser</h2>
                
                <div class="form-group">
                    <label for="nbSitesDetailed">Combien de sites souhaitez-vous analyser ?</label>
                    <input type="number" id="nbSitesDetailed" min="1" max="50" value="1" required>
                </div>

                <div class="form-navigation">
                    <button class="button secondary" onclick="resetCalculator()">Retour</button>
                    <button class="button" onclick="setupSites()">Suivant</button>
                </div>
            </div>

            <div class="form-step" id="step2">
                <h2>Site <span id="currentSiteNumber">1</span> sur <span id="totalSitesNumber">1</span></h2>
                
                <div class="site-form">
                    <div class="form-group">
                        <label for="siteName">Nom du site</label>
                        <input type="text" id="siteName" placeholder="Ex: Siège social" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="siteAddress">
                            Adresse du site
                            <span class="tooltip">
                                <span style="font-size: 0.9em; color: var(--willie-blue-primary);">ℹ</span>
                                <span class="tooltiptext">L'adresse nous permet de déterminer précisément le coût de l'eau dans votre commune pour un calcul plus précis</span>
                            </span>
                        </label>
                        <input type="text" id="siteAddress" placeholder="Commencez à taper l'adresse..." required autocomplete="street-address">
                        <div class="address-suggestions" id="addressSuggestions"></div>
                    </div>

                    <div class="form-group">
                        <label for="siteMeters">Nombre de compteurs d'eau</label>
                        <input type="number" id="siteMeters" min="1" placeholder="Ex: 5" required>
                    </div>

                    <div class="form-group">
                        <label for="siteConsumption">Consommation annuelle 2024 (m³)</label>
                        <input type="number" id="siteConsumption" min="0" placeholder="Ex: 5000" required>
                    </div>
                </div>

                <div class="site-navigation">
                    <div class="site-progress">
                        <div class="progress-dots">
                            <!-- Dots will be generated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button class="button secondary" onclick="navigateSite('prev')">← Précédent</button>
                    <button class="button" id="nextSiteBtn" onclick="navigateSite('next')">Suivant →</button>
                </div>
            </div>
        </div>

        <!-- Loading state -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Calcul de vos économies en cours...</p>
        </div>

        <!-- Results -->
        <div class="calculator-results" id="results">
            <div style="text-align: left; margin-bottom: var(--spacing-xl);">
                <button class="button secondary" onclick="backToForm()">← Modifier mes données</button>
            </div>
            
            <div class="main-savings">
                <h2>💰 VOS ÉCONOMIES POTENTIELLES AVEC WILLIE</h2>
                <div class="savings-amount">
                    <span class="counter" id="totalSavings">0</span> €/an
                </div>
                <p>Économies annuelles estimées sur votre facture d'eau</p>
                <div class="teaser-message">
                    <p style="font-weight: 600; margin-bottom: var(--spacing-xl);">
                        🔓 Débloquez votre analyse complète personnalisée :
                    </p>
                    <ul>
                        <li>Détail précis de vos économies par poste</li>
                        <li>Heures de productivité récupérées</li>
                        <li>Projection financière sur 5 ans</li>
                        <li>Protection contre les amendes CSRD</li>
                        <li>Impact sur votre notation ESG</li>
                        <li>Plan d'action personnalisé</li>
                    </ul>
                </div>
            </div>

            <div class="additional-benefits">
                <div class="benefit-card">
                    <span class="icon">🛡️</span>
                    <h4>Conformité garantie</h4>
                    <p>Évitez jusqu'à 3,75M€ d'amendes CSRD<br>Reporting eau automatisé et certifié</p>
                </div>
                <div class="benefit-card">
                    <span class="icon">🌿</span>
                    <h4>Performance RSE</h4>
                    <p>+15% sur votre notation extra-financière<br>Améliorez votre score ESG instantanément</p>
                </div>
                <div class="benefit-card">
                    <span class="icon">⚡</span>
                    <h4>Réactivité maximale</h4>
                    <p>Détection de fuites en temps réel<br>-95% sur les délais d'intervention</p>
                </div>
            </div>

            <div class="calculator-cta">
                <h3>📊 Recevez votre rapport détaillé personnalisé</h3>
                <p>Obtenez immédiatement votre analyse complète avec plan d'action sur mesure</p>
                <form class="elegant-form" id="emailForm">
                    <div class="form-row">
                        <div class="form-field">
                            <input type="text" id="firstName" required>
                            <label for="firstName">Prénom</label>
                        </div>
                        <div class="form-field">
                            <input type="text" id="lastName" required>
                            <label for="lastName">Nom</label>
                        </div>
                    </div>
                    <div class="form-field">
                        <input type="email" id="email" required>
                        <label for="email">Email professionnel</label>
                    </div>
                    <div class="form-field">
                        <input type="tel" id="phone">
                        <label for="phone">Téléphone (optionnel)</label>
                    </div>
                    
                    <div class="consent-group">
                        <input type="checkbox" id="consent" checked>
                        <label for="consent">J'accepte de recevoir mon rapport personnalisé et d'être contacté par un expert Willie pour discuter de mon projet</label>
                    </div>
                    
                    <button type="button" class="button submit-button" onclick="submitEmail()">
                        Recevoir mon rapport complet →
                    </button>
                </form>
            </div>
        </div>

        <!-- Success message -->
        <div class="success-message" id="successMessage">
            <div class="success-icon">✅</div>
            <h2>Parfait ! Votre rapport est en route</h2>
            <p>Votre analyse personnalisée a été envoyée à votre adresse email.</p>
            <p>Un expert Willie prendra contact avec vous sous 24h pour échanger sur vos besoins spécifiques.</p>
        </div>
    </div>

    <script>
        // Détecter si on est dans un iframe dès le début
        if (window.parent !== window) {
            document.body.classList.add('in-iframe');
        }

        // AUTO-HEIGHT POUR IFRAME - Version améliorée
        let lastHeight = 0;
        let heightTimeout = null;
        
        function sendHeight() {
            // Éviter les appels trop fréquents
            if (heightTimeout) {
                clearTimeout(heightTimeout);
            }
            
            heightTimeout = setTimeout(() => {
                // Forcer un recalcul du layout
                document.body.offsetHeight;
                
                // Obtenir la hauteur réelle incluant les marges
                const height = Math.max(
                    document.body.scrollHeight,
                    document.body.offsetHeight,
                    document.documentElement.clientHeight,
                    document.documentElement.scrollHeight,
                    document.documentElement.offsetHeight
                );
                
                // Envoyer seulement si la hauteur a changé
                if (Math.abs(height - lastHeight) > 5 && window.parent !== window) {
                    lastHeight = height;
                    window.parent.postMessage({ type: 'resize-iframe', height: height + 20 }, '*');
                }
            }, 100);
        }

        // Observer pour détecter les changements de contenu - avec debounce
        let resizeTimeout = null;
        const resizeObserver = new ResizeObserver(() => {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                sendHeight();
            }, 150);
        });

        // Observer le body pour détecter les changements
        document.addEventListener('DOMContentLoaded', function() {
            // Attendre que tout soit chargé avant d'observer
            setTimeout(() => {
                resizeObserver.observe(document.body);
                sendHeight();
            }, 500);
        });

        // Configuration
        const config = {
            waterPricePerM3: 4.50,
            reductionRate: 0.22,
            timePerMeter: 0.25,
            hourlyRate: 22,
            inflationRate: 0.05
        };

        // State
        let currentType = null;
        let currentStep = 1;
        let currentSiteIndex = 0;
        let totalSites = 1;
        let sitesData = [];
        let results = {};
        let formData = {}; // Store form data for navigation

        // Address suggestions (simulated - replace with real API)
        const addressSuggestions = [
            "1 Rue de la Paix, 75002 Paris",
            "10 Avenue des Champs-Élysées, 75008 Paris", 
            "25 Boulevard Saint-Germain, 75005 Paris",
            "15 Rue de Rivoli, 75001 Paris",
            "50 Avenue Montaigne, 75008 Paris"
        ];

        // Save form data
        function saveFormData() {
            if (currentType === 'simplified') {
                formData.simplified = {
                    nbSites: document.getElementById('nbSites').value,
                    nbCompteurs: document.getElementById('nbCompteurs').value,
                    consoType: document.querySelector('input[name="consoType"]:checked')?.value,
                    consoGlobaleValue: document.getElementById('consoGlobaleValue').value,
                    consoMoyenneValue: document.getElementById('consoMoyenneValue').value
                };
            }
        }

        // Save current site data
        function saveCurrentSiteData() {
            const siteData = {
                name: document.getElementById('siteName').value,
                address: document.getElementById('siteAddress').value,
                meters: document.getElementById('siteMeters').value,
                consumption: document.getElementById('siteConsumption').value
            };
            
            sitesData[currentSiteIndex] = siteData;
        }

        // Restore form data
        function restoreFormData() {
            if (currentType === 'simplified' && formData.simplified) {
                const data = formData.simplified;
                document.getElementById('nbSites').value = data.nbSites || 1;
                document.getElementById('nbCompteurs').value = data.nbCompteurs || '';
                if (data.consoType) {
                    document.querySelector(`input[name="consoType"][value="${data.consoType}"]`).checked = true;
                    document.getElementById('consoGlobaleValue').disabled = data.consoType !== 'global';
                    document.getElementById('consoMoyenneValue').disabled = data.consoType !== 'average';
                }
                document.getElementById('consoGlobaleValue').value = data.consoGlobaleValue || '';
                document.getElementById('consoMoyenneValue').value = data.consoMoyenneValue || '';
            }
        }

        // GTM tracking
        function trackEvent(eventName, parameters = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
            console.log('Track event:', eventName, parameters);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Type selector events
            document.querySelectorAll('.type-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectCalculatorType(this.dataset.type);
                });
            });

            // Radio button events
            document.querySelectorAll('input[name="consoType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('consoGlobaleValue').disabled = this.value !== 'global';
                    document.getElementById('consoMoyenneValue').disabled = this.value !== 'average';
                });
            });

            // Initial state
            document.getElementById('consoMoyenneValue').disabled = true;

            // Address autocomplete
            const addressInput = document.getElementById('siteAddress');
            if (addressInput) {
                addressInput.addEventListener('input', handleAddressInput);
                addressInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('addressSuggestions').classList.remove('active');
                    }, 200);
                });
            }

            // Handle touch events for better mobile experience
            if ('ontouchstart' in window) {
                document.querySelectorAll('.button, .type-option, .radio-option').forEach(el => {
                    el.addEventListener('touchstart', function() {
                        this.style.opacity = '0.8';
                    });
                    el.addEventListener('touchend', function() {
                        this.style.opacity = '1';
                    });
                });
            }
        });

        // Handle address input
        function handleAddressInput(e) {
            const value = e.target.value;
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            if (value.length > 2) {
                // Filter suggestions (in real app, this would be an API call)
                const filtered = addressSuggestions.filter(addr => 
                    addr.toLowerCase().includes(value.toLowerCase())
                );
                
                if (filtered.length > 0) {
                    suggestionsDiv.innerHTML = filtered.map(addr => 
                        `<div class="address-suggestion" onclick="selectAddress('${addr}')">${addr}</div>`
                    ).join('');
                    suggestionsDiv.classList.add('active');
                } else {
                    suggestionsDiv.classList.remove('active');
                }
            } else {
                suggestionsDiv.classList.remove('active');
            }
        }

        // Select address
        function selectAddress(address) {
            document.getElementById('siteAddress').value = address;
            document.getElementById('addressSuggestions').classList.remove('active');
        }

        // Calculator type selection
        function selectCalculatorType(type) {
            currentType = type;
            
            // Track selection
            trackEvent('calculator_type_selected', {
                'calculator_type': type
            });

            // Update UI
            document.querySelectorAll('.type-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');

            // Hide type selector
            document.getElementById('typeSelector').style.display = 'none';

            // Show appropriate form
            if (type === 'simplified') {
                document.getElementById('simplifiedForm').classList.add('active');
                setTimeout(restoreFormData, 100); // Restore saved data
            } else {
                document.getElementById('detailedForm').classList.add('active');
            }

            // Update progress
            updateProgress(40);
            setTimeout(sendHeight, 300);
        }

        // Back to form from results
        function backToForm() {
            document.getElementById('results').classList.remove('active');
            
            if (currentType === 'simplified') {
                document.getElementById('simplifiedForm').classList.add('active');
                restoreFormData();
            } else {
                document.getElementById('detailedForm').classList.add('active');
                showStep('step2');
            }
            
            updateProgress(70);
            setTimeout(sendHeight, 300);
        }

        // Progress bar
        function updateProgress(percentage) {
            document.querySelector('.progress-fill').style.width = percentage + '%';
        }

        // Reset calculator
        function resetCalculator() {
            // Reset state
            currentType = null;
            currentSiteIndex = 0;
            sitesData = [];
            
            // Hide all forms
            document.querySelectorAll('.calculator-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Hide results and loading
            document.getElementById('results').classList.remove('active');
            document.getElementById('loading').classList.remove('active');
            
            // Show type selector
            document.getElementById('typeSelector').style.display = 'grid';
            
            // Reset progress
            updateProgress(20);
            setTimeout(sendHeight, 300);
        }

        // Simplified calculation
        function calculateSimplified() {
            const nbSites = parseInt(document.getElementById('nbSites').value);
            const nbCompteurs = parseInt(document.getElementById('nbCompteurs').value);
            const consoType = document.querySelector('input[name="consoType"]:checked').value;
            
            let totalConsumption;
            if (consoType === 'global') {
                totalConsumption = parseFloat(document.getElementById('consoGlobaleValue').value);
            } else {
                const avgConsumption = parseFloat(document.getElementById('consoMoyenneValue').value);
                totalConsumption = avgConsumption * nbSites;
            }

            if (!nbSites || !nbCompteurs || !totalConsumption) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            // Save form data before calculating
            saveFormData();

            // Track values
            trackEvent('calculator_values_entered', {
                'sites_count': nbSites <= 5 ? 'low' : nbSites <= 20 ? 'medium' : 'high',
                'meters_count': nbCompteurs <= 50 ? 'low' : nbCompteurs <= 200 ? 'medium' : 'high',
                'consumption_range': totalConsumption <= 10000 ? 'low' : totalConsumption <= 50000 ? 'medium' : 'high'
            });

            // Show loading
            document.getElementById('simplifiedForm').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            updateProgress(70);
            setTimeout(sendHeight, 300);

            // Calculate results
            setTimeout(() => {
                calculateResults({
                    sites: nbSites,
                    meters: nbCompteurs,
                    consumption: totalConsumption
                });
            }, 1500);
        }

        // Setup sites for detailed form
        function setupSites() {
            const nbSites = parseInt(document.getElementById('nbSitesDetailed').value);
            
            if (!nbSites || nbSites < 1) {
                alert('Veuillez entrer un nombre de sites valide');
                return;
            }

            // Initialize sites data array
            totalSites = nbSites;
            sitesData = new Array(nbSites).fill(null).map(() => ({}));
            currentSiteIndex = 0;

            // Update UI
            updateSiteUI();
            
            // Show step 2
            showStep('step2');
            updateProgress(60);
            setTimeout(sendHeight, 300);
        }

        // Update site UI
        function updateSiteUI() {
            // Update site counter
            document.getElementById('currentSiteNumber').textContent = currentSiteIndex + 1;
            document.getElementById('totalSitesNumber').textContent = totalSites;

            // Update progress dots
            const dotsContainer = document.querySelector('.progress-dots');
            dotsContainer.innerHTML = '';
            
            for (let i = 0; i < totalSites; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i === currentSiteIndex) {
                    dot.classList.add('active');
                } else if (sitesData[i] && sitesData[i].name) {
                    dot.classList.add('completed');
                }
                dot.onclick = () => goToSite(i);
                dotsContainer.appendChild(dot);
            }

            // Load site data if exists
            if (sitesData[currentSiteIndex]) {
                const data = sitesData[currentSiteIndex];
                document.getElementById('siteName').value = data.name || '';
                document.getElementById('siteAddress').value = data.address || '';
                document.getElementById('siteMeters').value = data.meters || '';
                document.getElementById('siteConsumption').value = data.consumption || '';
            } else {
                // Clear form
                document.getElementById('siteName').value = '';
                document.getElementById('siteAddress').value = '';
                document.getElementById('siteMeters').value = '';
                document.getElementById('siteConsumption').value = '';
            }

            // Update navigation buttons
            const nextBtn = document.getElementById('nextSiteBtn');
            if (currentSiteIndex === totalSites - 1) {
                nextBtn.textContent = 'Calculer mes économies →';
                nextBtn.onclick = () => calculateDetailed();
            } else {
                nextBtn.textContent = 'Suivant →';
                nextBtn.onclick = () => navigateSite('next');
            }
        }

        // Navigate between sites
        function navigateSite(direction) {
            // Save current site data
            saveCurrentSiteData();

            if (direction === 'next') {
                if (validateCurrentSite()) {
                    if (currentSiteIndex < totalSites - 1) {
                        currentSiteIndex++;
                        updateSiteUI();
                    }
                }
            } else if (direction === 'prev') {
                if (currentSiteIndex > 0) {
                    currentSiteIndex--;
                    updateSiteUI();
                } else {
                    showStep('step1');
                }
            }
            setTimeout(sendHeight, 300);
        }

        // Go to specific site
        function goToSite(index) {
            saveCurrentSiteData();
            currentSiteIndex = index;
            updateSiteUI();
            setTimeout(sendHeight, 300);
        }

        // Validate current site
        function validateCurrentSite() {
            const name = document.getElementById('siteName').value;
            const address = document.getElementById('siteAddress').value;
            const meters = document.getElementById('siteMeters').value;
            const consumption = document.getElementById('siteConsumption').value;

            if (!name || !address || !meters || !consumption) {
                alert('Veuillez remplir tous les champs pour ce site');
                return false;
            }
            return true;
        }

        // Show step
        function showStep(stepId) {
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
            setTimeout(sendHeight, 300);
        }

        // Detailed calculation
        function calculateDetailed() {
            // Save current site data
            saveCurrentSiteData();

            // Validate all sites
            let allValid = true;
            let totalMeters = 0;
            let totalConsumption = 0;

            for (let i = 0; i < totalSites; i++) {
                if (!sitesData[i] || !sitesData[i].name || !sitesData[i].meters || !sitesData[i].consumption) {
                    allValid = false;
                    alert(`Veuillez compléter les informations du site ${i + 1}`);
                    currentSiteIndex = i;
                    updateSiteUI();
                    return;
                }
                totalMeters += parseInt(sitesData[i].meters);
                totalConsumption += parseFloat(sitesData[i].consumption);
            }

            // Track values
            trackEvent('calculator_values_entered', {
                'sites_count': totalSites <= 5 ? 'low' : totalSites <= 20 ? 'medium' : 'high',
                'meters_count': totalMeters <= 50 ? 'low' : totalMeters <= 200 ? 'medium' : 'high',
                'consumption_range': totalConsumption <= 10000 ? 'low' : totalConsumption <= 50000 ? 'medium' : 'high'
            });

            // Show loading
            document.getElementById('detailedForm').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            updateProgress(70);
            setTimeout(sendHeight, 300);

            // Calculate results
            setTimeout(() => {
                calculateResults({
                    sites: totalSites,
                    meters: totalMeters,
                    consumption: totalConsumption,
                    detailed: sitesData
                });
            }, 1500);
        }

        // Calculate results
        function calculateResults(data) {
            // Water savings
            const waterSaved = data.consumption * config.reductionRate;
            const waterSavingsEuros = waterSaved * config.waterPricePerM3;

            // Time savings
            const timeSaved = data.meters * config.timePerMeter * 12; // Monthly reading
            const timeSavingsEuros = timeSaved * config.hourlyRate;

            // Total annual savings
            const totalAnnualSavings = waterSavingsEuros + timeSavingsEuros;

            // 5-year projection with inflation
            let fiveYearSavings = 0;
            for (let i = 0; i < 5; i++) {
                fiveYearSavings += totalAnnualSavings * Math.pow(1 + config.inflationRate, i);
            }

            // Store results
            results = {
                waterSaved: Math.round(waterSaved),
                waterSavingsEuros: Math.round(waterSavingsEuros),
                timeSaved: Math.round(timeSaved),
                timeSavingsEuros: Math.round(timeSavingsEuros),
                totalAnnualSavings: Math.round(totalAnnualSavings),
                fiveYearSavings: Math.round(fiveYearSavings)
            };

            // Track results
            trackEvent('calculator_results_viewed', {
                'annual_savings': totalAnnualSavings <= 10000 ? 'low' : totalAnnualSavings <= 50000 ? 'medium' : 'high',
                'roi_years': 5
            });

            // Show results
            showResults();
        }

        // Show results
        function showResults() {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('results').classList.add('active');
            updateProgress(100);

            // Animate counter for main savings only
            animateCounter('totalSavings', results.totalAnnualSavings);
            
            // Store detailed results for the email report
            // These will be sent to backend when email is submitted
            console.log('Full results stored for report:', results);
            
            setTimeout(sendHeight, 300);
        }

        // Animate counter
        function animateCounter(elementId, target) {
            const element = document.getElementById(elementId);
            const duration = 2000;
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current).toLocaleString();
            }, 16);
        }

        // Submit email
        function submitEmail() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const consent = document.getElementById('consent').checked;

            // Validate required fields
            if (!firstName || !lastName || !email) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            if (!consent) {
                alert('Veuillez accepter de recevoir votre rapport personnalisé');
                return;
            }

            // Collect form data
            const emailData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                consent: true,
                calculationType: currentType,
                results: results,
                formData: currentType === 'simplified' ? formData : { sites: sitesData }
            };

            // Track submission
            const leadScore = results.totalAnnualSavings > 50000 ? 'high' : 
                           results.totalAnnualSavings > 20000 ? 'medium' : 'low';
            
            trackEvent('calculator_email_submitted', {
                'lead_score': leadScore
            });

            // Show success
            document.getElementById('results').style.display = 'none';
            document.getElementById('successMessage').classList.add('active');
            setTimeout(sendHeight, 300);

            // Here you would normally send the data to your backend
            console.log('Form submitted with complete data:', emailData);
            
            // Example API call (uncomment and adapt for your backend):
            /*
            fetch('https://your-api-endpoint.com/calculator-lead', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
            */
        }

        // Viewport height fix for mobile browsers
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // Set viewport height on load and resize
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
    </script>
</body>
</html>
